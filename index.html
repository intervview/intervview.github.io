<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; background: #f6f8fa; border-radius: 8px; }
        h1 { color: #24292f; }
        .upload-box { border: 2px dashed #cbd5e0; padding: 40px; border-radius: 10px; background: white; transition: 0.3s; }
        .upload-box:hover { border-color: #0366d6; background: #f0f7ff; }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 10px 20px; cursor: pointer; background: #2ea44f; color: white; border-radius: 6px; font-weight: bold; }
        .custom-file-upload:hover { background: #2c974b; }
        #fileName { margin-top: 15px; color: #555; font-weight: bold; }
        #progressBar { width: 100%; height: 10px; background: #e1e4e8; border-radius: 5px; margin-top: 20px; display: none; overflow: hidden; }
        #progressFill { height: 100%; background: #2ea44f; width: 0%; transition: width 0.3s; }
        #status { margin-top: 20px; font-size: 14px; }
        .success { color: #22863a; }
        .error { color: #cb2431; }
    </style>
</head>
<body>

    <h1>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ (–¥–æ 2 –ì–±)</h1>
    <p>–§–∞–π–ª –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Releases —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.</p>

    <div class="upload-box">
        <label for="fileInput" class="custom-file-upload">
            üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </label>
        <input type="file" id="fileInput">
        <div id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
    </div>

    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="status"></div>

    <script>
        // ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
        // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω (github_pat_...)
        const TOKEN = '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'; 
        const OWNER = 'intervview'; // –ù–∞–ø—Ä–∏–º–µ—Ä: octocat
        const REPO = 'intervview.github.io'; // –ù–∞–ø—Ä–∏–º–µ—Ä: my-video-site
        // =============================================

        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                fileNameDisplay.textContent = this.files[0].name;
                uploadFile(this.files[0]);
            }
        });

        async function uploadFile(file) {
            statusDiv.className = '';
            statusDiv.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
            progressBar.style.display = 'block';
            progressFill.style.width = '10%';

            const releaseTag = 'auto-upload-' + new Date().toISOString().slice(0,10);
            const releaseName = `–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç ${new Date().toLocaleTimeString()}`;

            try {
                // 1. –°–æ–∑–¥–∞–µ–º –†–µ–ª–∏–∑ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–∞–π–ª–∞)
                progressFill.style.width = '30%';
                const releaseResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tag_name: releaseTag,
                        name: releaseName,
                        body: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º',
                        draft: false,
                        prerelease: false
                    })
                });

                if (!releaseResp.ok) {
                    // –ï—Å–ª–∏ —Ä–µ–ª–∏–∑ —Å —Ç–∞–∫–∏–º —Ç–µ–≥–æ–º —É–∂–µ –µ—Å—Ç—å (—Ä–µ–¥–∫–æ), –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                    if(releaseResp.status === 422) {
                         const getResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases/tags/${releaseTag}`, {
                            headers: { 'Authorization': `Bearer ${TOKEN}` }
                         });
                         const data = await getResp.json();
                         if(data.upload_url) await uploadAsset(data.upload_url, file);
                         else throw new Error('–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ç–µ–≥–æ–≤');
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑');
                    }
                    return;
                }

                const releaseData = await releaseResp.json();
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∞–º —Ñ–∞–π–ª (Asset)
                await uploadAsset(releaseData.upload_url, file);

            } catch (error) {
                console.error(error);
                statusDiv.className = 'error';
                statusDiv.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                progressBar.style.display = 'none';
            }
        }

        async function uploadAsset(uploadUrlTemplate, file) {
            // –û—á–∏—â–∞–µ–º URL —à–∞–±–ª–æ–Ω–∞ –æ—Ç {name}
            const uploadUrl = uploadUrlTemplate.split('{?name,label}')[0] + `?name=${encodeURIComponent(file.name)}`;
            
            progressFill.style.width = '50%';
            statusDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', uploadUrl, true);
            xhr.setRequestHeader('Authorization', `Bearer ${TOKEN}`);
            xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
            // xhr.setRequestHeader('Content-Length', file.size); // GitHub –∏–Ω–æ–≥–¥–∞ —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ CORS, –ª—É—á—à–µ —É–±—Ä–∞—Ç—å

            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    statusDiv.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(percentComplete)}%`;
                }
            };

            xhr.onload = function() {
                if (xhr.status === 201) {
                    const response = JSON.parse(xhr.responseText);
                    statusDiv.className = 'success';
                    statusDiv.innerHTML = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω.<br><a href="${response.browser_download_url}" target="_blank">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
                    progressFill.style.width = '100%';
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + xhr.status);
                }
            };

            xhr.onerror = function() {
                throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            };

            xhr.send(file);
        }
    </script>
</body>
</html>
